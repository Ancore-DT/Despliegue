<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout/main :: head('Gestión de Usuarios')}"></head>
<body>
    <!-- Barra de navegación -->
    <nav th:replace="~{layout/main :: navbar}"></nav>

    <!-- Contenido principal -->
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-people"></i> Gestión de Usuarios</h2>
            <a th:href="@{/registro}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Nuevo Usuario
            </a>
        </div>

        <!-- Mensajes de alerta -->
        <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show">
            <span th:text="${mensaje}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Tabla de usuarios -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Roles</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${usuarios.empty}">
                                <td colspan="5" class="text-center">No hay usuarios registrados</td>
                            </tr>
                            <tr th:each="usuario : ${usuarios}">
                                <td th:text="${usuario.id}">1</td>
                                <td th:text="${usuario.username}">admin</td>
                                <td>
                                    <span th:each="rol : ${usuario.roles}" class="badge bg-info me-1" th:text="${rol}">ADMIN</span>
                                </td>
                                <td>
                                    <span th:if="${usuario.activo}" class="badge bg-success">Activo</span>
                                    <span th:unless="${usuario.activo}" class="badge bg-danger">Inactivo</span>
                                </td>
                                <td>
                                    <form th:action="@{/admin/usuarios/{id}/toggle-estado(id=${usuario.id})}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-sm" 
                                                th:classappend="${usuario.activo ? 'btn-warning' : 'btn-success'}"
                                                th:title="${usuario.activo ? 'Desactivar' : 'Activar'}">
                                            <i class="bi" th:classappend="${usuario.activo ? 'bi-toggle-on' : 'bi-toggle-off'}"></i>
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-danger btn-sm" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#eliminarModal"
                                            th:data-bs-id="${usuario.id}"
                                            th:data-bs-username="${usuario.username}"
                                            th:disabled="${usuario.username == 'admin'}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Volver al panel de administración -->
        <div class="mt-3">
            <a th:href="@{/admin}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver al Panel
            </a>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="eliminarModalLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar el usuario <span id="usernameUsuario"></span>?</p>
                    <p class="text-danger">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="formEliminar" th:action="@{/admin/usuarios/{id}/eliminar}" method="post">
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer th:replace="~{layout/main :: footer}"></footer>

    <!-- Scripts -->
    <div th:replace="~{layout/main :: scripts}"></div>
    
    <!-- Script para el modal de eliminación -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const eliminarModal = document.getElementById('eliminarModal');
            if (eliminarModal) {
                eliminarModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const id = button.getAttribute('data-bs-id');
                    const username = button.getAttribute('data-bs-username');
                    
                    const usernameUsuario = document.getElementById('usernameUsuario');
                    usernameUsuario.textContent = username;
                    
                    const formEliminar = document.getElementById('formEliminar');
                    formEliminar.action = formEliminar.action.replace('{id}', id);
                });
            }
        });
    </script>
</body>
</html>